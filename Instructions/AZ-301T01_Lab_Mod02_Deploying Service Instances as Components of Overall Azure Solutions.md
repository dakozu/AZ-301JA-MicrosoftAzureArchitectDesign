---
lab:
    title: 'Azure ソリューション全体のコンポーネントとしてサービス インスタンスをデプロイする'
    module: 'モジュール 2: Azure プラットフォームで利用できる SaaS サービスの統合'
---

# Azure プラットフォームで利用可能な SaaS サービスの統合

# ラボの回答キー: Azure ソリューション全体のコンポーネントとしてサービス インスタンスをデプロイする

## はじめに

1. 次の認証情報を使用して Windows 10 ラボ仮想マシンにログインしていることを確認します。

    - ユーザー名: **Admin**

    - パスワード: **Pa55w.rd**

1. Windows 10 デスクトップの下部にあるタスク バーを確認します。タスク バーには、ラボで使用する一般的なアプリケーションのアイコンがあります。

    - Microsoft Edge

    - ファイル エクスプローラ

    - [Visual Studio Code](https://code.visualstudio.com/)

    - [Microsoft Azure Storage Explorer](https://azure.microsoft.com/features/storage-explorer/)

    - Ubuntu または Windows 上の Bash

    - Windows PowerShell

    > **注意**: これらのアプリケーションへのショートカットは、「**スタート メニュー**」 にあります。

## 演習 1: ARM テンプレートを使用した関数アプリと Cognitive Service のデプロイ

#### タスク 1: Azure Portalを開く

1. タスク バーで、「**Microsoft Edge**」 アイコンをクリックします。

1. 開いているブラウザ ウィンドウで、**Azure Portal** (<https://portal.azure.com>) に移動します。

1. プロンプトが表示された場合は、このラボで使用する Azure サブスクリプションの所有者役割を持つユーザー アカウントを使用して認証します。

#### タスク 2: Azure Resource Manager テンプレートを使用した Cognitive Service のデプロイ

1. Azure portal の左上隅にある **リソースの作成** をクリックします。

1.  **新規** ブレードの上部にある **マーケットプレースの検索** テキストボックスに、 **Template Deployment** と入力し、 **Enter** キーを押します。

1. 「**すべて**」 ブレードの検索結果で 「**Template Deployment (カスタム テンプレートを使用してデプロイする)**」 をクリックします。

1. **テンプレートのデプロイ** ブレードで、 **作成** ボタンをクリックします。

1.  **カスタムデプロイ** ブレードで、 **エディターで独自のテンプレートを作成** リンクをクリックします。

1.  **テンプレートの編集** ブレードで、 **ファイルの読み込み** をクリックします。

1.  **アップロードするファイルを選択** ダイアログ ボックスで、**\\allfiles\\AZ-301T01\\Module_02\\LabFiles\\Starter\\** フォルダーに移動して、**cognitive-template.json** ファイルを選択し、 **開く** をクリックします。これにより、テンプレート エディタ ペインに次のコンテンツが読み込まれます。

```json
    {
        "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "variables": {
            "serviceName": "[concat('cgnt', uniqueString(resourceGroup().id))]"
        },
        "resources": [
            {
                "apiVersion": "2017-04-18",
                "type": "Microsoft.CognitiveServices/accounts",
                "name": "[variables('serviceName')]",
                "kind": "TextAnalytics",
                "location": "[resourceGroup().location]",
                "sku": {
                    "name": "S1"
                },
                "properties": {}
            }
        ],
        "outputs": {
            "cognitiveEndpointUrl": {
                "type": "string",
                "value": "[reference(variables('serviceName')).endpoint]"
            },
            "cognitiveEndpointKey": {
                "type": "string",
                "value": "[listKeys(variables('serviceName'), '2017-04-18').key1]"
            }
        }
    }
```

1.  **保存** ボタンをクリックしてテンプレートを保持します。

1.  **カスタムデプロイ** ブレードに戻って、次のタスクを実行します。

    -  **サブスクリプション** ドロップダウンリストエントリは、既定値に設定したままにします。

    -  **リソース グループ** セクションで、 **新規作成** オプションが選択されていることを確認し、テキストボックスに **AADesignLab1001-RG** と入力します。

    -  **場所** ロップダウン リストで、このラボでリソースをデプロイするAzureリージョンを選択します。

    -  **利用規約** セクションで、 **上記の利用規約に同意する** チェックボックスを選択します。

    -  **購入** ボタンをクリックします。

1. デプロイが完了するのを待ってから、次の手順に進みます。 

1. Azure portalのハブメニューで、 **リソースグループ** をクリックします。

1.  **リソース グループ** ブレードで、 **AADesignLab1001-RG** をクリックします。

1.  **AADesignLab1001-RG** ブレードで、ブレードの上部にある  **デプロイ**  ヘッダーの下にある  **デプロイ**  ラベルをクリックします。このラベルは、成功したデプロイの数を示します。

1. 「デプロイ」 ブレードで、最新のデプロイの名前をクリックします。

1. 「**Microsoft.Template - 概要**」 ブレードで、「**出力**」をクリックします。 

1. 「**Microsoft.Template - 出力**」ブレードで、「**cognitiveEndpointUrl**」出力と「**cognitiveEndpointKey**」出力の値を確認します。これらの値は、後でラボで必要になるので、記録してください。

#### タスク 3: Function Appをデプロイする

1. Azure portal の左上隅にある **リソースの作成** をクリックします。

1.  **新規** ブレードの上部にある **マーケットプレースの検索** テキストボックスに、 **Function App** と入力し、 **Enter** キーを押します。

1.  **すべて** ブレードの検索結果で  **Function App** をクリックします。

1.  **関数アプリ** ブレードで、 **作成** ボタンをクリックします。

1. 次の  **関数アプリ**  ブレードで、次のタスクを実行します。

    -  **アプリ名** テキストボックスに、グローバルに一意の名前を入力します。
    
    -  **サブスクリプション** ドロップダウンリストエントリは、既定値に設定したままにします。

    -  **リソースグループ** セクションで、 **既存のものを使用** オプションを選択し、ドロップダウンリストで  **AADesignLab1001-RG** を選択します。

    - 「**地域**」 ドロップダウン リストで、前のタスクで Cognitive Service のインスタンスをデプロイした Azure リージョンを選択します。
    
    - 「**ランタイム スタック**」 ドロップダウン リストで、「**.NET Core**」 エントリが選択されていることを確認します。 
    
    - 「**ストレージ**」 セクションで、「**(新規)**」 オプションが選択されていることを確認し、ストレージ アカウント名の既定値を受け入れます。 
        
    - 「**オペレーティング システム**」 セクションで、「**Windows**」 ボタンが選択されていることを確認します。

    - 「**プランの種類**」 ドロップダウン リストで、「**消費量(サーバーレス)**」 エントリが選択されていることを確認します。

    - 「**Application Insights**」 セクションで、オプションを 「**いいえ**」 に設定します。

    -  **作成**  ボタンをクリックします。

1. 関数アプリのプロビジョニングが完了するのを待ってから、次の手順に進みます。 

1. Azure portalのハブメニューで、 **リソースグループ** をクリックします。

1.  **リソース グループ** ブレードで、 **AADesignLab1001-RG** をクリックします。

1. 「**AADesignLab1001-RG**」 ブレードのリソースの一覧で、新しくプロビジョニングされた関数アプリをクリックします。

１．**概要** ブレードにて **従来のエクスペリエンスに切り替える - 従来のエクスペリエンスを続行する** をクリックします

1. 「関数アプリ」 ブレードの上部にある 「**プラットフォーム機能**」 をクリックします。

1. 「**プラットフォームの機能**」 タブで、「**全般設定**」 セクションの 「**構成**」 リンクをクリックします。

1. 「**アプリケーション設定**」 タブで、「**アプリケーション設定**」 セクションを見つけます。「**+ 新しいアプリケーション設定**」 リンクをクリックし、次のタスクを実行します。

    - 「**名前**」 テキスト ボックスで、「**EndpointUrl**」と入力します。

    - [**値**] テキスト ボックスに、前に特定した **cognitiveEndpointUrl** の値を入力し、その後に **text/analytics/v2.0** を入力します。

1. 「**アプリケーション設定**」 セクションで、「**新しい設定を追加**」 リンクをもう一度クリックし、次のタスクを実行します。

    - 「**名前を入力**」 テキストボックスに 「**EndpointKey**」と入力します。

    - 「**値を入力**」 テキストボックスに、前で識別した 「**cognitiveEndpointKey**」 の値を入力します。

1. 「**アプリケーション設定**」 タブの上部にある 「**保存**」 ボタンをクリックします。

1. 関数アプリ ブレードに戻り、[**プラットフォームの機能**]タブで、[**コードデプロイ**] セクションの [**コンテナーの設定**] リンクをクリックします。

1. 「**デプロイ センター**」 ブレードで、「**External**」をクリックした後、「**続行**」 をクリックします。

1. 「**App Service のビルド サービス**」 をクリックし、「**続行**」 をクリックします。 

1. 「**コード**」 セクションが表示されたら、次のタスクを実行します。

    - 「**リポジトリ**」 テキストボックスに「**https://github.com/azure-labs/cognitive-services-function**」と入力します。

    - 「**検索**」 テキストボックスに 「**master**」 と入力します。
    
        > **注意**: 「ブランチ」 フィールドでは大文字と小文字が区別されます。

    - **Repository Type** の値を **Git** に設定します。

    - **Private Repository** の値を **いいえ** に設定します。

    - 「**続行**」 ボタンをクリックします。

1. 「**完了**」 をクリックし、デプロイが完了するのを待ってから、次のタスクに進みます。 

    > **注意**: 「**デプロイ**」 タブを監視することで、最初のデプロイが完了したことを確認できます。このタブは自動的に更新されます。

#### タスク 4: Cognitive Services を使用して関数アプリをテストする

1. 「関数アプリ」 ブレードに戻って、「**関数**」 をクリックして関数のリストをデプロイします。

    > **注意**: 関数のリストを更新するには、「**関数**」 を 2 回クリックしてください。

1. 関数リストから 「**DetermineLanguage**」 を選択します。

1. 表示される 「**run.csx**」 ペインの右側にある 「**テスト**」 をクリックします。

1. 「**テスト**」 ペインで、次のタスクを実行します。

    - 「**要求本文**」 テキストボックスに次のように入力します。

```json
    {
        "text": "I stuffed a shirt or two into my old carpet-bag, tucked it under my arm, and started for Cape Horn and the Pacific."
    }
```

    - 「**実行**」 ボタンをクリックします。

    - 「**出力**」 セクションで出力を確認します。出力を通じて、言語が 「**en**」 (英語) であることを確認できます。

> **確認**: この演習では、Azure Cognitive Services を使用する関数アプリを作成しました。


## 演習 2: 関数アプリを使用するロジック アプリを作成

#### タスク 1: ロジック アプリを作成する

1. Azure portal の左上隅にある **リソースの作成** をクリックします。

1. 「**新規**」 ブレードの上部にある 「**マーケットプレースの検索**」 テキストボックスに、「**Logic App**」と入力し、**Enter** キーを押します。

1. 「**すべて**」 ブレードの検索結果で 「**Logic App**」 をクリックします。

1. 「**ロジック アプリ**」 ブレードで、「**作成**」 ボタンをクリックします。

1. 「**ロジック アプリの作成**」 ブレードで、次のタスクを実行します。

    - 「**ロジック アプリ名**」 テキストボックスに、値 「**CognitiveWorkflow**」 の値を入力します。
    
    -  **サブスクリプション** ドロップダウンリストエントリは、既定値に設定したままにします。

    -  **リソースグループ** セクションで、 ドロップダウンリストで  **AADesignLab1001-RG** を選択します。

    - 「**場所**」 ドロップダウン リストで、このラボの前の演習で選択したのと同じ Azure リージョンを選択します。 

    - 「**Log Analytics**」 セクションで、「**オフ**」 ボタンが選択されていることを確認します。

    -  **作成** ボタンをクリックします。

1. プロビジョニングが完了するのを待ってから、次のタスクに進みます。 

#### タスク 2: ロジック アプリの手順を設定する

1. Azure Portalのハブメニューで、 **リソースグループ** をクリックします。

1.  **リソース グループ** ブレードで、 **AADesignLab1001-RG** をクリックします。

1. 「**AADesignLab1001-RG**」 ブレードで、前のタスクで作成したロジック アプリを表すエントリをクリックします。

1. **ロジック アプリのデザイナー** ブレードで、、「**テンプレート**」 セクションの 「**空のロジック アプリ**」 タイルをクリックします。

1. 「**ロジック アプリのデザイナー**」 ブレードの上部にある 「**コード ビュー**」 ボタンをクリックします。

1. 「**ロジック アプリのデザイナー**」 ブレードで、空白のロジック アプリ JSON テンプレートを確認します。

```json
    {
        "definition": {
            "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
            "actions": {},
            "contentVersion": "1.0.0.0",
            "outputs": {},
            "parameters": {},
            "triggers": {}
        }
    }
```

1. デフォルトの JSON テンプレートを HTTP トリガーが含まれている次のテンプレート (**\\allfiles\\AZ-301T01\\Module_02\\LabFiles\\Starter\\logic-app.json**) に置き換えます。

```json
    {
        "definition": {
            "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
            "actions": {},
            "contentVersion": "1.0.0.0",
            "outputs": {},
            "parameters": {},
            "triggers": {
                "manual": {
                    "inputs": {
                        "method": "POST",
                        "schema": {
                            "properties": {
                                "text": {
                                    "type": "string"
                                }
                            },
                            "type": "object"
                        }
                    },
                    "kind": "Http",
                    "type": "Request"
                }
            }
        }
    }
```

1. 「**ロジック アプリのデザイナー**」 ブレードで、「**デザイナー**」 ボタンをクリックします。

    > **注意**: この時点で、デザイナーに 1 つのステップが表示されます。このステップは、ワークフローを開始する「トリガー」ステップです。

1. デザイナーで 「**+ 新しいステップ**」 ボタンをクリックします。

1. 「**アクションの選択**」 セクションで、次のタスクを実行します。

    - 「検索」 テキストボックスに 「**Azure Functions**」 と入力します。

    - 検索結果で、「**Azure 関数を選択する**」 という名前のアクションを選択します。

    - 次の一連の検索結果で、このラボの前の演習で作成した Azure Function インスタンスを選択します。

    - 最後の一連の検索結果で、アクションに使用される **DetermineLanguage** 関数を選択します。

1. 「**DetermineLanguage**」 ステップで、次のタスクを実行します。

    - 「**要求本文**」 テキストボックスに 「**@triggerBody()**」 と入力します。

    - 「**方法**」 ドロップダウン リストで、「**POST**」 オプションを選択します。

1. デザイナーで 「**+ 新しいステップ**」 ボタンをクリックします。「**アクションを追加**」 ボタンをクリックして、アクションを作成するためのダイアログを開きます。

1. 表示される 「**アクションの選択**」 ダイアログ ボックスで、次のタスクを実行します。

    - 「検索」 テキストボックスに 「**Azure Functions**」 と入力します。

    - 検索結果で、「**Azure 関数を選択する**」 という名前のアクションを選択します。

    - 次の一連の検索結果で、このラボの前の演習で作成した Azure Function インスタンスを選択します。

    - 最後の一連の検索結果で、アクションに使用される **DetermineKeyPhrases** 関数を選択します。

1. 「**DetermineKeyPhrases**」 ステップで、次のタスクを実行します。

    - 「**要求本文**」 テキストボックスに、値 「**@body('DetermineLanguage')**」 を入力します。

    - 「**方法**」 ドロップダウン リストで、「**POST**」 オプションを選択します。

1. デザイナーで 「**+ 新しいステップ**」 ボタンをクリックします。 

1. 表示される 「**アクションの選択**」 ダイアログ ボックスで、次のタスクを実行します。

    - 「検索」 テキストボックスに「 **応答**」 と入力します。

    - 検索結果で、「**応答 - 要求**」 という名前の **アクション** を選択します。

1. 「**応答**」 手順で、次のタスクを実行します。

    - 「**状態コード**」 テキストボックスで、値 **200** が指定されていることを確認します。

    - 「**本文**」 テキストボックスに 「**@body('DetermineKeyPhrases')**」 と入力します。

1. 「**ロジック アプリのデザイナー**」 ブレードの上部にある 「**保存**」 ボタンをクリックしてワークフローを保持します。

1. 「**ロジック アプリのデザイナー**」 領域の上部までスク役割し、「**HTTP 要求を受信したとき**」 ステップをクリックします。

1. 「**HTTP POST URL**」 ボックスボックスの値をコピーします。この URL は、この演習の後半で使用されます。

#### タスク 2: Cloud Shellを開く

1. Portalの上部にある **Cloud Shell** アイコンをクリックして、新しいシェルインスタンスを開きます。

    > **注意**:  **Cloud Shell** アイコンは、*より大きい* 文字と *下線*文字の組み合わせで構成される記号です。

1. サブスクリプションを使用して **Cloud Shell** を初めて開く場合は、初めて使用する **Cloud Shell** を設定するウィザードが表示されます。プロンプトが表示された場合は、 **Azure Cloud Shellへようこそ** ウィンドウで、 **Bash (Linux)** をクリックします。

    > **注意**: **Cloud Shell** の環境設定オプションが表示されない場合は、このコースのラボで既存のサブスクリプションを使用している可能性が高いと考えられます。その場合は、次のタスクに直接進みます。 

1.  **ストレージがマウントされていない** ウィンドウで、 **詳細設定を表示** をクリックし、次のタスクを実行します。

    -  **サブスクリプション** ドロップダウンリストエントリは、既定値に設定したままにします。

    - 「**Cloud Shell リージョン**」 ドロップダウン リストで、このラボでリソースをデプロイした場所と一致する、またはその近くにある Azure リージョンを選択します

    -  **リソースグループ** セクションで、 **既存のものを使用** オプションを選択し、ドロップダウンリストで  **AADesignLab1001-RG** を選択します。

    -  **ストレージ アカウント** セクションで、 **新規作成** オプションが選択されていることを確認し、下のテキストボックスに3 - 24つの文字と数字の組み合わせで構成される一意の名前を入力します。 

    -  **ファイル共有** セクションで **新規作成** オプションが選択されていることを確認し、下のテキストボックスに **cloudshell** と入力します。

    - 「**ストレージの作成**」 ボタンをクリックします。

1.  **Cloud Shell** が初回セットアップ手順を完了するのを待ってから、次のタスクに進みます。

#### タスク 3: Python を使用してロジック アプリを検証する

1. ポータルの下部にある **Cloud Shell** コマンド プロンプトで、次のコマンドを入力し、**Enter** キーを押して、対話型 **Python** ターミナルを開きます。

```
    python
```

1. ポータルの下部にある **Cloud Shell** コマンド プロンプトで、次のコマンドを入力し、**Enter** キーを押して、「**要求**」 ライブラリをインポートします。

```python
    import requests
```

1. ポータルの下部にある **Cloud Shell** コマンド プロンプトで、次のコマンド (プレースホルダ`<logic app POST Url>`をこの演習の前半で記録した URL の値に置き換える) を入力し、**Enter** キーを押して、ロジック アプリの URL の値が含まれている変数を作成します。

```python
    url = "<logic app POST Url>"
```

1. ポータルの下部にある **Cloud Shell** コマンド プロンプトで、次のコマンドを入力し、**Enter** キーを押すると、HTTP POST 要求が送信されて、ロジック アプリのワークフローをトリガーします。

```python
    response = requests.post(url, json={'text': 'Circumambulate the city of a dreamy Sabbath afternoon. Go from Corlears Hook to Coenties Slip, and from thence, by Whitehall, northward.'})
```

1. ポータルの下部にある **Cloud Shell** コマンド プロンプトで、次のコマンドを入力し、**Enter** キーを押して、ロジック アプリ ワークフローの出力を表示します。

```python
    print(response.status_code, response.reason, response.text)
```

1.   **Cloud Shell** ペインを閉じます。

> **確認**: この演習では、このラボの前の演習で作成した関数アプリを利用するロジック アプリを作成しました。

## 演習 3: 課題 リソースの削除

#### タスク 1: Cloud Shellを開く

1. Portalの上部にある **Cloud Shell** アイコンをクリックして、「Cloud Shell」ペインを開きます。

1.  **Cloud Shell** コマンドプロンプトで、次のコマンドを入力し、 **Enter** キーを押して、このラボで作成したすべてのリソースグループを一覧表示します。

```
    az group list --query "[?starts_with(name,'AADesignLab10')]".name --output tsv
```

1. このラボで作成したリソース グループのみが出力に含まれていることを確認します。これらのグループは、次のタスクで削除されます。

#### タスク 2: リソース グループの削除

1.  **Cloud Shell** コマンドプロンプトで、次のコマンドを入力し、 **Enter** キーを押してこのラボで作成したリソースグループを削除します。

```sh
    az group list --query "[?starts_with(name,'AADesignLab10')]".name --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
```

1. Portalの下部にある **Cloud Shell** プロンプトを閉じます。

> **確認**: この演習では、このラボで使用したリソースを削除しました。
